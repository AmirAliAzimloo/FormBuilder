name: Continuous Integration and Continuous Deployment

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  actions: read
  contents: read

jobs:
  # CI
  build-and-test:
    runs-on: ubuntu-latest

  steps:
    - uses: actions/checkout@v2
      with:
      fetch-depth: 0 # Fetch all history for all branches and tags

    # Connect your workspace on nx.app and uncomment this to enable task distribution.
    # The "--stop-agents-after" is optional, but allows idle agents to shut down once the "e2e-ci" targets have been requested
    # - run: npx nx-cloud start-ci-run --distribute-on="5 linux-medium-js" --stop-agents-after="e2e-ci"

    - name: Use Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.14.0'

    - name: Install dependencies
      run: npm install

    - name: Run lint
      run: npm run lint

    - name: Run format check
      run: npm run format

    - name: Check commit messages
      uses: wagoid/commitlint-github-action@v3
      with:
        configFile: commitlint.config.cjs

    - name: Run npm ci
    - run: npm ci
    - uses: nrwl/nx-set-shas@v4

    # Prepend any command with "nx-cloud record --" to record its logs to Nx Cloud
    # - run: npx nx-cloud record -- echo Hello World
    - name: Run tests
    - run: npx nx affected -t lint test build
    - run: npx nx affected --parallel 1 -t e2e-ci

    - name: Build Docker Image
      run: docker build -t formbuilder:1.0 .

    - name: Push Docker Image to Registry
      run: |
        docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
        docker push formbuilder:1.0
